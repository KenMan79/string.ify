"use strict";

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var O = Object,
    bullet = require('string.bullet'),
    isBrowser = typeof window !== 'undefined' && window.window === window && window.navigator,
    maxOf = function maxOf(arr, pick) {
    return arr.reduce(function (max, s) {
        return Math.max(max, pick ? pick(s) : s);
    }, 0);
},
    isInteger = Number.isInteger || function (value) {
    return typeof value === 'number' && isFinite(value) && Math.floor(value) === value;
},
    isTypedArray = function isTypedArray(x) {
    return x instanceof Float32Array || x instanceof Float64Array || x instanceof Int8Array || x instanceof Uint8Array || x instanceof Uint8ClampedArray || x instanceof Int16Array || x instanceof Int32Array || x instanceof Uint32Array;
};

var assignProps = function assignProps(to, from) {
    for (var prop in from) {
        O.defineProperty(to, prop, O.getOwnPropertyDescriptor(from, prop));
    };return to;
};

var escapeStr = function escapeStr(x) {
    return x.replace(/\n/g, '\\n').replace(/\'/g, "\\'").replace(/\"/g, '\\"');
};

var _configure = function _configure(cfg) {

    var stringify = function stringify(x) {

        var state = O.assign({ parents: new Set(), siblings: new Map() }, cfg);

        if (cfg.pretty === 'auto') {
            var oneLine = stringify.configure({ pretty: false, siblings: new Map() })(x);
            return oneLine.length <= 60 ? oneLine : stringify.configure({ pretty: true, siblings: new Map() })(x);
        }

        var customFormat = cfg.formatter && cfg.formatter(x, stringify);

        if (typeof customFormat === 'string') {
            return customFormat;
        }

        if (typeof jQuery !== 'undefined' && x instanceof jQuery) {
            x = x.toArray();
        } else if (isTypedArray(x)) {
            x = Array.from(x);
        }

        if (isBrowser && x === window) {
            return 'window';
        } else if (!isBrowser && typeof global !== 'undefined' && x === global) {
            return 'global';
        } else if (x === null) {
            return 'null';
        } else if (x instanceof Date) {
            return state.pure ? x.getTime() : "ðŸ“…  " + x.toString();
        } else if (state.parents.has(x)) {
            return state.pure ? undefined : '<cyclic>';
        } else if (!state.pure && state.siblings.has(x)) {
            return '<ref:' + state.siblings.get(x) + '>';
        } else if (x && typeof Symbol !== 'undefined' && (customFormat = x[Symbol.for('String.ify')]) && typeof customFormat === 'function' && typeof (customFormat = customFormat.call(x, stringify.configure(state))) === 'string') {

            return customFormat;
        } else if (x instanceof Function) {
            return cfg.pure ? x.toString() : x.name ? '<function:' + x.name + '>' : '<function>';
        } else if (typeof x === 'string') {
            return '"' + escapeStr(stringify.limit(x, cfg.pure ? Number.MAX_SAFE_INTEGER : cfg.maxStringLength)) + '"';
        } else if (x instanceof Promise && !state.pure) {
            return '<Promise>';
        } else if ((typeof x === 'undefined' ? 'undefined' : _typeof(x)) === 'object') {

            state.parents.add(x);
            state.siblings.set(x, state.siblings.size);

            var result = stringify.configure(O.assign({}, state, { pretty: state.pretty === false ? false : 'auto', depth: state.depth + 1 })).object(x);

            state.parents.delete(x);

            return result;
        } else if (!isInteger(x) && cfg.precision > 0) {
            return x.toFixed(cfg.precision);
        } else {
            return String(x);
        }
    };

    /*  API  */

    assignProps(stringify, {

        state: cfg,

        configure: function configure(newConfig) {
            return _configure(O.assign({}, cfg, newConfig));
        },

        /*  TODO: generalize generation of these chain-style .configure helpers (maybe in a separate library, as it looks like a common pattern)    */

        get pretty() {
            return stringify.configure({ pretty: true });
        },
        get noPretty() {
            return stringify.configure({ pretty: false });
        },

        get json() {
            return stringify.configure({ json: true, pure: true });
        },
        get pure() {
            return stringify.configure({ pure: true });
        },

        maxStringLength: function maxStringLength() {
            var n = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Number.MAX_SAFE_INTEGER;
            return stringify.configure({ maxStringLength: n });
        },
        maxArrayLength: function maxArrayLength() {
            var n = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Number.MAX_SAFE_INTEGER;
            return stringify.configure({ maxArrayLength: n });
        },
        maxDepth: function maxDepth() {
            var n = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Number.MAX_SAFE_INTEGER;
            return stringify.configure({ maxDepth: n });
        },
        precision: function precision(p) {
            return stringify.configure({ precision: p });
        },
        formatter: function formatter(f) {
            return stringify.configure({ formatter: f });
        },


        /*  Some undocumented internals    */

        limit: function limit(s, n) {
            return s && (s.length <= n ? s : s.substr(0, n - 1) + 'â€¦');
        },

        rightAlign: function rightAlign(strings) {
            var max = maxOf(strings, function (s) {
                return s.length;
            });
            return strings.map(function (s) {
                return ' '.repeat(max - s.length) + s;
            });
        },

        object: function object(x) {

            if (x instanceof Set) {
                x = Array.from(x.values());
            } else if (x instanceof Map) {
                x = Array.from(x.entries());
            }

            var isArray = Array.isArray(x);

            if (isBrowser) {

                if (x instanceof Element) {
                    return '<' + (x.tagName.toLowerCase() + (x.id && '#' + x.id || '') + (x.className && '.' + x.className || '')) + '>';
                } else if (x instanceof Text) {
                    return '@' + stringify.limit(x.wholeText, 20);
                }
            }

            if (!cfg.pure && (cfg.depth > cfg.maxDepth || isArray && x.length > cfg.maxArrayLength)) {
                return isArray ? '<array[' + x.length + ']>' : '<object>';
            }

            var pretty = cfg.pretty ? true : false,
                entries = O.entries(x),
                oneLine = !pretty || entries.length < 2,
                quoteKey = cfg.json ? function (k) {
                return '"' + escapeStr(k) + '"';
            } : function (k) {
                return (/^[A-z][A-z0-9]*$/.test(k) ? k : "'" + escapeStr(k) + "'"
                );
            };

            if (pretty) {

                var values = O.values(x),
                    printedKeys = stringify.rightAlign(O.keys(x).map(function (k) {
                    return quoteKey(k) + ': ';
                })),
                    printedValues = values.map(stringify),
                    leftPaddings = printedValues.map(function (x, i) {
                    return x[0] === '[' || x[0] === '{' ? 3 : typeof values[i] === 'string' ? 1 : 0;
                }),
                    maxLeftPadding = maxOf(leftPaddings),
                    items = leftPaddings.map(function (padding, i) {
                    var value = ' '.repeat(maxLeftPadding - padding) + printedValues[i];
                    return isArray ? value : bullet(printedKeys[i], value);
                }),
                    printed = bullet(isArray ? '[ ' : '{ ', items.join(',\n')),
                    lines = printed.split('\n'),
                    lastLine = lines[lines.length - 1];

                return printed + (' '.repeat(maxOf(lines, function (l) {
                    return l.length;
                }) - lastLine.length) + (isArray ? ' ]' : ' }'));
            } else {

                var _items = entries.map(function (kv) {
                    return (isArray ? '' : quoteKey(kv[0]) + ': ') + stringify(kv[1]);
                }),
                    content = _items.join(', ');

                return isArray ? '[' + content + ']' : '{ ' + content + ' }';
            }
        }
    });

    return stringify;
};

module.exports = _configure({

    depth: 0,
    pure: false,
    json: false,
    //  color:           false, // not supported yet
    maxDepth: 5,
    maxArrayLength: 60,
    maxStringLength: 60,
    precision: undefined,
    formatter: undefined,
    pretty: 'auto'

});

//# sourceMappingURL=data:application/json;base64,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QUgsQ0FBWCxDQUFuRDtBQUFBLGlCQUFiLENBQWhCO0FBQUEsb0JBQ00sVUFBVSxPQUFNLElBQU4sQ0FBWSxJQUFaLENBRGhCOztBQUdBLHVCQUFPLFVBQ0ksTUFBTyxPQUFQLEdBQWtCLEdBRHRCLEdBRUksT0FBTyxPQUFQLEdBQWlCLElBRjVCO0FBR0g7QUFDSjtBQTFGbUIsS0FBeEI7O0FBNkZBLFdBQU8sU0FBUDtBQUNILENBektMOztBQTJLQSxPQUFPLE9BQVAsR0FBaUIsV0FBVzs7QUFFUixXQUFpQixDQUZUO0FBR1IsVUFBaUIsS0FIVDtBQUlSLFVBQWlCLEtBSlQ7QUFLWjtBQUNJLGNBQWlCLENBTlQ7QUFPUixvQkFBaUIsRUFQVDtBQVFSLHFCQUFpQixFQVJUO0FBU1IsZUFBaUIsU0FUVDtBQVVSLGVBQWlCLFNBVlQ7QUFXUixZQUFnQjs7QUFYUixDQUFYLENBQWpCIiwiZmlsZSI6InN0cmluZy5pZnkuZXM1LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IE8gICAgICAgICAgICA9IE9iamVjdCxcbiAgICAgIGJ1bGxldCAgICAgICA9IHJlcXVpcmUgKCdzdHJpbmcuYnVsbGV0JyksXG4gICAgICBpc0Jyb3dzZXIgICAgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpICYmICh3aW5kb3cud2luZG93ID09PSB3aW5kb3cpICYmIHdpbmRvdy5uYXZpZ2F0b3IsXG4gICAgICBtYXhPZiAgICAgICAgPSAoYXJyLCBwaWNrKSA9PiBhcnIucmVkdWNlICgobWF4LCBzKSA9PiBNYXRoLm1heCAobWF4LCBwaWNrID8gcGljayAocykgOiBzKSwgMCksXG4gICAgICBpc0ludGVnZXIgICAgPSBOdW1iZXIuaXNJbnRlZ2VyIHx8ICh2YWx1ZSA9PiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgJiYgaXNGaW5pdGUgKHZhbHVlKSAmJiAoTWF0aC5mbG9vciAodmFsdWUpID09PSB2YWx1ZSkpLFxuICAgICAgaXNUeXBlZEFycmF5ID0geCA9PiAoeCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50OEFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50MTZBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBJbnQzMkFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KVxuXG5jb25zdCBhc3NpZ25Qcm9wcyA9ICh0bywgZnJvbSkgPT4geyBmb3IgKGNvbnN0IHByb3AgaW4gZnJvbSkgeyBPLmRlZmluZVByb3BlcnR5ICh0bywgcHJvcCwgTy5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IgKGZyb20sIHByb3ApKSB9OyByZXR1cm4gdG8gfVxuXG5jb25zdCBlc2NhcGVTdHIgPSB4ID0+IHgucmVwbGFjZSAoL1xcbi9nLCAnXFxcXG4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UgKC9cXCcvZywgXCJcXFxcJ1wiKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UgKC9cXFwiL2csICdcXFxcXCInKVxuXG5jb25zdCBjb25maWd1cmUgPSBjZmcgPT4ge1xuXG4gICAgY29uc3Qgc3RyaW5naWZ5ID0geCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gTy5hc3NpZ24gKHsgcGFyZW50czogbmV3IFNldCAoKSwgc2libGluZ3M6IG5ldyBNYXAgKCkgfSwgY2ZnKVxuXG4gICAgICAgICAgICBpZiAoY2ZnLnByZXR0eSA9PT0gJ2F1dG8nKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgICBvbmVMaW5lID0gICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwcmV0dHk6IGZhbHNlLCBzaWJsaW5nczogbmV3IE1hcCAoKSB9KSAoeClcbiAgICAgICAgICAgICAgICByZXR1cm4gKG9uZUxpbmUubGVuZ3RoIDw9IDYwKSA/IG9uZUxpbmUgOiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZXR0eTogdHJ1ZSwgIHNpYmxpbmdzOiBuZXcgTWFwICgpIH0pICh4KSB9XG5cbiAgICAgICAgICAgIHZhciBjdXN0b21Gb3JtYXQgPSBjZmcuZm9ybWF0dGVyICYmIGNmZy5mb3JtYXR0ZXIgKHgsIHN0cmluZ2lmeSlcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXN0b21Gb3JtYXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1c3RvbUZvcm1hdCB9XG5cbiAgICAgICAgICAgIGlmICgodHlwZW9mIGpRdWVyeSAhPT0gJ3VuZGVmaW5lZCcpICYmICh4IGluc3RhbmNlb2YgalF1ZXJ5KSkge1xuICAgICAgICAgICAgICAgIHggPSB4LnRvQXJyYXkgKCkgfVxuXG4gICAgICAgICAgICBlbHNlIGlmIChpc1R5cGVkQXJyYXkgKHgpKSB7XG4gICAgICAgICAgICAgICAgeCA9IEFycmF5LmZyb20gKHgpIH1cblxuICAgICAgICAgICAgaWYgKGlzQnJvd3NlciAmJiAoeCA9PT0gd2luZG93KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnd2luZG93JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKCFpc0Jyb3dzZXIgJiYgKHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSAmJiAoeCA9PT0gZ2xvYmFsKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnZ2xvYmFsJyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ251bGwnIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUucHVyZSA/IHguZ2V0VGltZSAoKSA6IFwi8J+ThSAgXCIgKyB4LnRvU3RyaW5nICgpIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGUucGFyZW50cy5oYXMgKHgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnB1cmUgPyB1bmRlZmluZWQgOiAnPGN5Y2xpYz4nIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoIXN0YXRlLnB1cmUgJiYgc3RhdGUuc2libGluZ3MuaGFzICh4KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPHJlZjonICsgc3RhdGUuc2libGluZ3MuZ2V0ICh4KSArICc+JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggJiYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnKVxuICAgICAgICAgICAgICAgICAgICAgICAmJiAoY3VzdG9tRm9ybWF0ID0geFtTeW1ib2wuZm9yICgnU3RyaW5nLmlmeScpXSlcbiAgICAgICAgICAgICAgICAgICAgICAgJiYgKHR5cGVvZiBjdXN0b21Gb3JtYXQgPT09ICdmdW5jdGlvbicpXG4gICAgICAgICAgICAgICAgICAgICAgICYmICh0eXBlb2YgKGN1c3RvbUZvcm1hdCA9IGN1c3RvbUZvcm1hdC5jYWxsICh4LCBzdHJpbmdpZnkuY29uZmlndXJlIChzdGF0ZSkpKSA9PT0gJ3N0cmluZycpKSB7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY3VzdG9tRm9ybWF0IH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChjZmcucHVyZSA/IHgudG9TdHJpbmcgKCkgOiAoeC5uYW1lID8gKCc8ZnVuY3Rpb246JyArIHgubmFtZSArICc+JykgOiAnPGZ1bmN0aW9uPicpKSB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB4ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnXCInICsgZXNjYXBlU3RyIChzdHJpbmdpZnkubGltaXQgKHgsIGNmZy5wdXJlID8gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgOiBjZmcubWF4U3RyaW5nTGVuZ3RoKSkgKyAnXCInIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoKHggaW5zdGFuY2VvZiBQcm9taXNlKSAmJiAhc3RhdGUucHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPFByb21pc2U+JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB4ID09PSAnb2JqZWN0Jykge1xuXG4gICAgICAgICAgICAgICAgc3RhdGUucGFyZW50cy5hZGQgKHgpXG4gICAgICAgICAgICAgICAgc3RhdGUuc2libGluZ3Muc2V0ICh4LCBzdGF0ZS5zaWJsaW5ncy5zaXplKVxuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoTy5hc3NpZ24gKHt9LCBzdGF0ZSwgeyBwcmV0dHk6IHN0YXRlLnByZXR0eSA9PT0gZmFsc2UgPyBmYWxzZSA6ICdhdXRvJywgZGVwdGg6IHN0YXRlLmRlcHRoICsgMSB9KSkub2JqZWN0ICh4KVxuXG4gICAgICAgICAgICAgICAgc3RhdGUucGFyZW50cy5kZWxldGUgKHgpXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0IH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoIWlzSW50ZWdlciAoeCkgJiYgKGNmZy5wcmVjaXNpb24gPiAwKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4LnRvRml4ZWQgKGNmZy5wcmVjaXNpb24pIH1cblxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyAoeCkgfVxuICAgICAgICB9XG5cbiAgICAvKiAgQVBJICAqL1xuXG4gICAgICAgIGFzc2lnblByb3BzIChzdHJpbmdpZnksIHtcblxuICAgICAgICAgICAgc3RhdGU6IGNmZyxcblxuICAgICAgICAgICAgY29uZmlndXJlOiBuZXdDb25maWcgPT4gY29uZmlndXJlIChPLmFzc2lnbiAoe30sIGNmZywgbmV3Q29uZmlnKSksXG5cbiAgICAgICAgLyogIFRPRE86IGdlbmVyYWxpemUgZ2VuZXJhdGlvbiBvZiB0aGVzZSBjaGFpbi1zdHlsZSAuY29uZmlndXJlIGhlbHBlcnMgKG1heWJlIGluIGEgc2VwYXJhdGUgbGlicmFyeSwgYXMgaXQgbG9va3MgbGlrZSBhIGNvbW1vbiBwYXR0ZXJuKSAgICAqL1xuXG4gICAgICAgICAgICBnZXQgcHJldHR5ICAgKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwcmV0dHk6IHRydWUgfSkgfSxcbiAgICAgICAgICAgIGdldCBub1ByZXR0eSAoKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZXR0eTogZmFsc2UgfSkgfSxcblxuICAgICAgICAgICAgZ2V0IGpzb24gKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBqc29uOiB0cnVlLCBwdXJlOiB0cnVlIH0pIH0sXG4gICAgICAgICAgICBnZXQgcHVyZSAoKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHB1cmU6IHRydWUgfSkgfSxcblxuICAgICAgICAgICAgbWF4U3RyaW5nTGVuZ3RoIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4U3RyaW5nTGVuZ3RoOiBuIH0pIH0sXG4gICAgICAgICAgICBtYXhBcnJheUxlbmd0aCAgKG4gPSBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUikgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBtYXhBcnJheUxlbmd0aDogbiB9KSB9LFxuICAgICAgICAgICAgbWF4RGVwdGggICAgICAgIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4RGVwdGg6IG4gfSkgfSxcblxuICAgICAgICAgICAgcHJlY2lzaW9uIChwKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZWNpc2lvbjogcCB9KSB9LFxuICAgICAgICAgICAgZm9ybWF0dGVyIChmKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IGZvcm1hdHRlcjogZiB9KSB9LFxuXG4gICAgICAgIC8qICBTb21lIHVuZG9jdW1lbnRlZCBpbnRlcm5hbHMgICAgKi9cblxuICAgICAgICAgICAgbGltaXQ6IChzLCBuKSA9PiBzICYmICgocy5sZW5ndGggPD0gbikgPyBzIDogKHMuc3Vic3RyICgwLCBuIC0gMSkgKyAn4oCmJykpLFxuXG4gICAgICAgICAgICByaWdodEFsaWduOiBzdHJpbmdzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF4ID0gbWF4T2YgKHN0cmluZ3MsIHMgPT4gcy5sZW5ndGgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ3MubWFwIChzID0+ICcgJy5yZXBlYXQgKG1heCAtIHMubGVuZ3RoKSArIHMpIH0sXG5cbiAgICAgICAgICAgIG9iamVjdDogeCA9PiB7XG5cbiAgICAgICAgICAgICAgICBpZiAoeCBpbnN0YW5jZW9mIFNldCkge1xuICAgICAgICAgICAgICAgICAgICB4ID0gQXJyYXkuZnJvbSAoeC52YWx1ZXMgKCkpIH1cblxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHggaW5zdGFuY2VvZiBNYXApIHtcbiAgICAgICAgICAgICAgICAgICAgeCA9IEFycmF5LmZyb20gKHguZW50cmllcyAoKSkgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgKHgpXG5cbiAgICAgICAgICAgICAgICBpZiAoaXNCcm93c2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoeCBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnPCcgKyAoeC50YWdOYW1lLnRvTG93ZXJDYXNlICgpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoeC5pZCAmJiAoJyMnICsgeC5pZCkpIHx8ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKHguY2xhc3NOYW1lICYmICgnLicgKyB4LmNsYXNzTmFtZSkpIHx8ICcnKSkgKyAnPicgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIFRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnQCcgKyBzdHJpbmdpZnkubGltaXQgKHgud2hvbGVUZXh0LCAyMCkgfSB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIWNmZy5wdXJlICYmICgoY2ZnLmRlcHRoID4gY2ZnLm1heERlcHRoKSB8fCAoaXNBcnJheSAmJiAoeC5sZW5ndGggPiBjZmcubWF4QXJyYXlMZW5ndGgpKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzQXJyYXkgPyAnPGFycmF5WycgKyB4Lmxlbmd0aCArICddPicgOiAnPG9iamVjdD4nIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IHByZXR0eSAgID0gY2ZnLnByZXR0eSA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICBlbnRyaWVzICA9IE8uZW50cmllcyAoeCksXG4gICAgICAgICAgICAgICAgICAgICAgb25lTGluZSAgPSAhcHJldHR5IHx8IChlbnRyaWVzLmxlbmd0aCA8IDIpLFxuICAgICAgICAgICAgICAgICAgICAgIHF1b3RlS2V5ID0gKGNmZy5qc29uID8gKGsgPT4gJ1wiJyArIGVzY2FwZVN0ciAoaykgKyAnXCInKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoayA9PiAvXltBLXpdW0EtejAtOV0qJC8udGVzdCAoaykgPyBrIDogKFwiJ1wiICsgZXNjYXBlU3RyIChrKSArIFwiJ1wiKSkpXG5cbiAgICAgICAgICAgICAgICBpZiAocHJldHR5KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVzICAgICAgICA9IE8udmFsdWVzICh4KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRlZEtleXMgICA9IHN0cmluZ2lmeS5yaWdodEFsaWduIChPLmtleXMgKHgpLm1hcCAoayA9PiBxdW90ZUtleSAoaykgKyAnOiAnKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZWRWYWx1ZXMgPSB2YWx1ZXMubWFwIChzdHJpbmdpZnkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0UGFkZGluZ3MgID0gcHJpbnRlZFZhbHVlcy5tYXAgKCh4LCBpKSA9PiAoKCh4WzBdID09PSAnWycpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHhbMF0gPT09ICd7JykpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoKHR5cGVvZiB2YWx1ZXNbaV0gPT09ICdzdHJpbmcnKSA/IDEgOiAwKSkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhMZWZ0UGFkZGluZyA9IG1heE9mIChsZWZ0UGFkZGluZ3MpLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gbGVmdFBhZGRpbmdzLm1hcCAoKHBhZGRpbmcsIGkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSAnICcucmVwZWF0IChtYXhMZWZ0UGFkZGluZyAtIHBhZGRpbmcpICsgcHJpbnRlZFZhbHVlc1tpXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNBcnJheSA/IHZhbHVlIDogYnVsbGV0IChwcmludGVkS2V5c1tpXSwgdmFsdWUpIH0pLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZWQgPSBidWxsZXQgKGlzQXJyYXkgPyAnWyAnIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ICcsIGl0ZW1zLmpvaW4gKCcsXFxuJykpLFxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzICAgID0gcHJpbnRlZC5zcGxpdCAoJ1xcbicpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TGluZSA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByaW50ZWQgKyAgKCcgJy5yZXBlYXQgKG1heE9mIChsaW5lcywgbCA9PiBsLmxlbmd0aCkgLSBsYXN0TGluZS5sZW5ndGgpICsgKGlzQXJyYXkgPyAnIF0nIDogJyB9JykpIH1cblxuICAgICAgICAgICAgICAgIGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zICAgPSBlbnRyaWVzLm1hcCAoa3YgPT4gKGlzQXJyYXkgPyAnJyA6IChxdW90ZUtleSAoa3ZbMF0pICsgJzogJykpICsgc3RyaW5naWZ5IChrdlsxXSkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gaXRlbXMuam9pbiAoJywgJylcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNBcnJheVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gKCdbJyAgKyBjb250ZW50ICsgICddJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICgneyAnICsgY29udGVudCArICcgfScpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiBzdHJpbmdpZnlcbiAgICB9XG5cbm1vZHVsZS5leHBvcnRzID0gY29uZmlndXJlICh7XG5cbiAgICAgICAgICAgICAgICAgICAgZGVwdGg6ICAgICAgICAgICAwLFxuICAgICAgICAgICAgICAgICAgICBwdXJlOiAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBqc29uOiAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgICAgIC8vICBjb2xvcjogICAgICAgICAgIGZhbHNlLCAvLyBub3Qgc3VwcG9ydGVkIHlldFxuICAgICAgICAgICAgICAgICAgICBtYXhEZXB0aDogICAgICAgIDUsXG4gICAgICAgICAgICAgICAgICAgIG1heEFycmF5TGVuZ3RoOiAgNjAsXG4gICAgICAgICAgICAgICAgICAgIG1heFN0cmluZ0xlbmd0aDogNjAsXG4gICAgICAgICAgICAgICAgICAgIHByZWNpc2lvbjogICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6ICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgcHJldHR5OiAgICAgICAgICdhdXRvJ1xuXG4gICAgICAgICAgICAgICAgfSlcblxuXG5cbiJdfQ==