"use strict";

function _objectValues(obj) {
    var values = [];
    var keys = Object.keys(obj);

    for (var k = 0; k < keys.length; ++k) values.push(obj[keys[k]]);

    return values;
}

function _objectEntries(obj) {
    var entries = [];
    var keys = Object.keys(obj);

    for (var k = 0; k < keys.length; ++k) entries.push([keys[k], obj[keys[k]]]);

    return entries;
}

const bullet = require('string.bullet'),
      isBrowser = typeof window !== 'undefined' && window.window === window && window.navigator,
      maxOf = (arr, pick) => arr.reduce((max, s) => Math.max(max, pick ? pick(s) : s), 0),
      isInteger = Number.isInteger || (value => typeof value === 'number' && isFinite(value) && Math.floor(value) === value),
      isTypedArray = x => x instanceof Float32Array || x instanceof Float64Array || x instanceof Int8Array || x instanceof Uint8Array || x instanceof Uint8ClampedArray || x instanceof Int16Array || x instanceof Int32Array || x instanceof Uint32Array;

const assignProps = (to, from) => {
    for (const prop in from) {
        Object.defineProperty(to, prop, Object.getOwnPropertyDescriptor(from, prop));
    };return to;
};

const escapeStr = x => x.replace(/\n/g, '\\n').replace(/\'/g, "\\'").replace(/\"/g, '\\"');

const configure = cfg => {

    const stringify = x => {

        const state = Object.assign({ parents: new Set(), siblings: new Map() }, cfg);

        if (cfg.pretty === 'auto') {
            const oneLine = stringify.configure({ pretty: false, siblings: new Map() })(x);
            return oneLine.length <= 60 ? oneLine : stringify.configure({ pretty: true, siblings: new Map() })(x);
        }

        var customFormat = cfg.formatter && cfg.formatter(x, stringify);

        if (typeof customFormat === 'string') {
            return customFormat;
        }

        if (typeof jQuery !== 'undefined' && x instanceof jQuery) {
            x = x.toArray();
        } else if (isTypedArray(x)) {
            x = Array.from(x);
        }

        if (isBrowser && x === window) {
            return 'window';
        } else if (!isBrowser && typeof global !== 'undefined' && x === global) {
            return 'global';
        } else if (x === null) {
            return 'null';
        } else if (x instanceof Date) {
            return state.pure ? x.getTime() : "ðŸ“…  " + x.toString();
        } else if (state.parents.has(x)) {
            return state.pure ? undefined : '<cyclic>';
        } else if (!state.pure && state.siblings.has(x)) {
            return '<ref:' + state.siblings.get(x) + '>';
        } else if (x && typeof Symbol !== 'undefined' && (customFormat = x[Symbol.for('String.ify')]) && typeof customFormat === 'function' && typeof (customFormat = customFormat.call(x, stringify.configure(state))) === 'string') {

            return customFormat;
        } else if (x instanceof Function) {
            return cfg.pure ? x.toString() : x.name ? '<function:' + x.name + '>' : '<function>';
        } else if (typeof x === 'string') {
            return '"' + escapeStr(stringify.limit(x, cfg.pure ? Number.MAX_SAFE_INTEGER : cfg.maxStringLength)) + '"';
        } else if (x instanceof Promise && !state.pure) {
            return '<Promise>';
        } else if (typeof x === 'object') {

            state.parents.add(x);
            state.siblings.set(x, state.siblings.size);

            const result = stringify.configure(Object.assign({}, state, { pretty: state.pretty === false ? false : 'auto', depth: state.depth + 1 })).object(x);

            state.parents.delete(x);

            return result;
        } else if (!isInteger(x) && cfg.precision > 0) {
            return x.toFixed(cfg.precision);
        } else {
            return String(x);
        }
    };

    /*  API  */

    assignProps(stringify, {

        state: cfg,

        configure: newConfig => configure(Object.assign({}, cfg, newConfig)),

        /*  TODO: generalize generation of these chain-style .configure helpers (maybe in a separate library, as it looks like a common pattern)    */

        get pretty() {
            return stringify.configure({ pretty: true });
        },
        get noPretty() {
            return stringify.configure({ pretty: false });
        },

        get json() {
            return stringify.configure({ json: true, pure: true });
        },
        get pure() {
            return stringify.configure({ pure: true });
        },

        maxStringLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxStringLength: n });
        },
        maxArrayLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxArrayLength: n });
        },
        maxDepth(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxDepth: n });
        },

        precision(p) {
            return stringify.configure({ precision: p });
        },
        formatter(f) {
            return stringify.configure({ formatter: f });
        },

        /*  Some undocumented internals    */

        limit: (s, n) => s && (s.length <= n ? s : s.substr(0, n - 1) + 'â€¦'),

        rightAlign: strings => {
            var max = maxOf(strings, s => s.length);
            return strings.map(s => ' '.repeat(max - s.length) + s);
        },

        object: x => {

            if (x instanceof Set) {
                x = Array.from(x.values());
            } else if (x instanceof Map) {
                x = Array.from(x.entries());
            }

            const isArray = Array.isArray(x);

            if (isBrowser) {

                if (x instanceof Element) {
                    return '<' + (x.tagName.toLowerCase() + (x.id && '#' + x.id || '') + (x.className && '.' + x.className || '')) + '>';
                } else if (x instanceof Text) {
                    return '@' + stringify.limit(x.wholeText, 20);
                }
            }

            if (!cfg.pure && (cfg.depth > cfg.maxDepth || isArray && x.length > cfg.maxArrayLength)) {
                return isArray ? '<array[' + x.length + ']>' : '<object>';
            }

            const pretty = cfg.pretty ? true : false,
                  entries = _objectEntries(x),
                  oneLine = !pretty || entries.length < 2,
                  quoteKey = cfg.json ? k => '"' + escapeStr(k) + '"' : k => /^[A-z][A-z0-9]*$/.test(k) ? k : "'" + escapeStr(k) + "'";

            if (pretty) {

                const values = _objectValues(x),
                      printedKeys = stringify.rightAlign(Object.keys(x).map(k => quoteKey(k) + ': ')),
                      printedValues = values.map(stringify),
                      leftPaddings = printedValues.map((x, i) => x[0] === '[' || x[0] === '{' ? 3 : typeof values[i] === 'string' ? 1 : 0),
                      maxLeftPadding = maxOf(leftPaddings),
                      items = leftPaddings.map((padding, i) => {
                    const value = ' '.repeat(maxLeftPadding - padding) + printedValues[i];
                    return isArray ? value : bullet(printedKeys[i], value);
                }),
                      printed = bullet(isArray ? '[ ' : '{ ', items.join(',\n')),
                      lines = printed.split('\n'),
                      lastLine = lines[lines.length - 1];

                return printed + (' '.repeat(maxOf(lines, l => l.length) - lastLine.length) + (isArray ? ' ]' : ' }'));
            } else {

                const items = entries.map(kv => (isArray ? '' : quoteKey(kv[0]) + ': ') + stringify(kv[1])),
                      content = items.join(', ');

                return isArray ? '[' + content + ']' : '{ ' + content + ' }';
            }
        }
    });

    return stringify;
};

module.exports = configure({

    depth: 0,
    pure: false,
    json: false,
    //  color:           false, // not supported yet
    maxDepth: 5,
    maxArrayLength: 60,
    maxStringLength: 60,
    precision: undefined,
    formatter: undefined,
    pretty: 'auto'

});

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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c0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IGJ1bGxldCAgICAgICA9IHJlcXVpcmUgKCdzdHJpbmcuYnVsbGV0JyksXG4gICAgICBpc0Jyb3dzZXIgICAgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpICYmICh3aW5kb3cud2luZG93ID09PSB3aW5kb3cpICYmIHdpbmRvdy5uYXZpZ2F0b3IsXG4gICAgICBtYXhPZiAgICAgICAgPSAoYXJyLCBwaWNrKSA9PiBhcnIucmVkdWNlICgobWF4LCBzKSA9PiBNYXRoLm1heCAobWF4LCBwaWNrID8gcGljayAocykgOiBzKSwgMCksXG4gICAgICBpc0ludGVnZXIgICAgPSBOdW1iZXIuaXNJbnRlZ2VyIHx8ICh2YWx1ZSA9PiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgJiYgaXNGaW5pdGUgKHZhbHVlKSAmJiAoTWF0aC5mbG9vciAodmFsdWUpID09PSB2YWx1ZSkpLFxuICAgICAgaXNUeXBlZEFycmF5ID0geCA9PiAoeCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50OEFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50MTZBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBJbnQzMkFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KVxuXG5jb25zdCBhc3NpZ25Qcm9wcyA9ICh0bywgZnJvbSkgPT4geyBmb3IgKGNvbnN0IHByb3AgaW4gZnJvbSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkgKHRvLCBwcm9wLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIChmcm9tLCBwcm9wKSkgfTsgcmV0dXJuIHRvIH1cblxuY29uc3QgZXNjYXBlU3RyID0geCA9PiB4LnJlcGxhY2UgKC9cXG4vZywgJ1xcXFxuJylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlICgvXFwnL2csIFwiXFxcXCdcIilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlICgvXFxcIi9nLCAnXFxcXFwiJylcblxuY29uc3QgY29uZmlndXJlID0gY2ZnID0+IHtcblxuICAgIGNvbnN0IHN0cmluZ2lmeSA9IHggPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IE9iamVjdC5hc3NpZ24gKHsgcGFyZW50czogbmV3IFNldCAoKSwgc2libGluZ3M6IG5ldyBNYXAgKCkgfSwgY2ZnKVxuXG4gICAgICAgICAgICBpZiAoY2ZnLnByZXR0eSA9PT0gJ2F1dG8nKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgICBvbmVMaW5lID0gICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwcmV0dHk6IGZhbHNlLCBzaWJsaW5nczogbmV3IE1hcCAoKSB9KSAoeClcbiAgICAgICAgICAgICAgICByZXR1cm4gKG9uZUxpbmUubGVuZ3RoIDw9IDYwKSA/IG9uZUxpbmUgOiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZXR0eTogdHJ1ZSwgIHNpYmxpbmdzOiBuZXcgTWFwICgpIH0pICh4KSB9XG5cbiAgICAgICAgICAgIHZhciBjdXN0b21Gb3JtYXQgPSBjZmcuZm9ybWF0dGVyICYmIGNmZy5mb3JtYXR0ZXIgKHgsIHN0cmluZ2lmeSlcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjdXN0b21Gb3JtYXQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1c3RvbUZvcm1hdCB9XG5cbiAgICAgICAgICAgIGlmICgodHlwZW9mIGpRdWVyeSAhPT0gJ3VuZGVmaW5lZCcpICYmICh4IGluc3RhbmNlb2YgalF1ZXJ5KSkge1xuICAgICAgICAgICAgICAgIHggPSB4LnRvQXJyYXkgKCkgfVxuXG4gICAgICAgICAgICBlbHNlIGlmIChpc1R5cGVkQXJyYXkgKHgpKSB7XG4gICAgICAgICAgICAgICAgeCA9IEFycmF5LmZyb20gKHgpIH1cblxuICAgICAgICAgICAgaWYgKGlzQnJvd3NlciAmJiAoeCA9PT0gd2luZG93KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnd2luZG93JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKCFpc0Jyb3dzZXIgJiYgKHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSAmJiAoeCA9PT0gZ2xvYmFsKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnZ2xvYmFsJyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ251bGwnIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUucHVyZSA/IHguZ2V0VGltZSAoKSA6IFwi8J+ThSAgXCIgKyB4LnRvU3RyaW5nICgpIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGUucGFyZW50cy5oYXMgKHgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnB1cmUgPyB1bmRlZmluZWQgOiAnPGN5Y2xpYz4nIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoIXN0YXRlLnB1cmUgJiYgc3RhdGUuc2libGluZ3MuaGFzICh4KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPHJlZjonICsgc3RhdGUuc2libGluZ3MuZ2V0ICh4KSArICc+JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggJiYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnKVxuICAgICAgICAgICAgICAgICAgICAgICAmJiAoY3VzdG9tRm9ybWF0ID0geFtTeW1ib2wuZm9yICgnU3RyaW5nLmlmeScpXSlcbiAgICAgICAgICAgICAgICAgICAgICAgJiYgKHR5cGVvZiBjdXN0b21Gb3JtYXQgPT09ICdmdW5jdGlvbicpXG4gICAgICAgICAgICAgICAgICAgICAgICYmICh0eXBlb2YgKGN1c3RvbUZvcm1hdCA9IGN1c3RvbUZvcm1hdC5jYWxsICh4LCBzdHJpbmdpZnkuY29uZmlndXJlIChzdGF0ZSkpKSA9PT0gJ3N0cmluZycpKSB7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY3VzdG9tRm9ybWF0IH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChjZmcucHVyZSA/IHgudG9TdHJpbmcgKCkgOiAoeC5uYW1lID8gKCc8ZnVuY3Rpb246JyArIHgubmFtZSArICc+JykgOiAnPGZ1bmN0aW9uPicpKSB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB4ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnXCInICsgZXNjYXBlU3RyIChzdHJpbmdpZnkubGltaXQgKHgsIGNmZy5wdXJlID8gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgOiBjZmcubWF4U3RyaW5nTGVuZ3RoKSkgKyAnXCInIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoKHggaW5zdGFuY2VvZiBQcm9taXNlKSAmJiAhc3RhdGUucHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAnPFByb21pc2U+JyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiB4ID09PSAnb2JqZWN0Jykge1xuXG4gICAgICAgICAgICAgICAgc3RhdGUucGFyZW50cy5hZGQgKHgpXG4gICAgICAgICAgICAgICAgc3RhdGUuc2libGluZ3Muc2V0ICh4LCBzdGF0ZS5zaWJsaW5ncy5zaXplKVxuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoT2JqZWN0LmFzc2lnbiAoe30sIHN0YXRlLCB7IHByZXR0eTogc3RhdGUucHJldHR5ID09PSBmYWxzZSA/IGZhbHNlIDogJ2F1dG8nLCBkZXB0aDogc3RhdGUuZGVwdGggKyAxIH0pKS5vYmplY3QgKHgpXG5cbiAgICAgICAgICAgICAgICBzdGF0ZS5wYXJlbnRzLmRlbGV0ZSAoeClcblxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICghaXNJbnRlZ2VyICh4KSAmJiAoY2ZnLnByZWNpc2lvbiA+IDApKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHgudG9GaXhlZCAoY2ZnLnByZWNpc2lvbikgfVxuXG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nICh4KSB9XG4gICAgICAgIH1cblxuICAgIC8qICBBUEkgICovXG5cbiAgICAgICAgYXNzaWduUHJvcHMgKHN0cmluZ2lmeSwge1xuXG4gICAgICAgICAgICBzdGF0ZTogY2ZnLFxuXG4gICAgICAgICAgICBjb25maWd1cmU6IG5ld0NvbmZpZyA9PiBjb25maWd1cmUgKE9iamVjdC5hc3NpZ24gKHt9LCBjZmcsIG5ld0NvbmZpZykpLFxuXG4gICAgICAgIC8qICBUT0RPOiBnZW5lcmFsaXplIGdlbmVyYXRpb24gb2YgdGhlc2UgY2hhaW4tc3R5bGUgLmNvbmZpZ3VyZSBoZWxwZXJzIChtYXliZSBpbiBhIHNlcGFyYXRlIGxpYnJhcnksIGFzIGl0IGxvb2tzIGxpa2UgYSBjb21tb24gcGF0dGVybikgICAgKi9cblxuICAgICAgICAgICAgZ2V0IHByZXR0eSAgICgpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgcHJldHR5OiB0cnVlIH0pIH0sXG4gICAgICAgICAgICBnZXQgbm9QcmV0dHkgKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwcmV0dHk6IGZhbHNlIH0pIH0sXG5cbiAgICAgICAgICAgIGdldCBqc29uICgpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsganNvbjogdHJ1ZSwgcHVyZTogdHJ1ZSB9KSB9LFxuICAgICAgICAgICAgZ2V0IHB1cmUgKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwdXJlOiB0cnVlIH0pIH0sXG5cbiAgICAgICAgICAgIG1heFN0cmluZ0xlbmd0aCAobiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IG1heFN0cmluZ0xlbmd0aDogbiB9KSB9LFxuICAgICAgICAgICAgbWF4QXJyYXlMZW5ndGggIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4QXJyYXlMZW5ndGg6IG4gfSkgfSxcbiAgICAgICAgICAgIG1heERlcHRoICAgICAgICAobiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IG1heERlcHRoOiBuIH0pIH0sXG5cbiAgICAgICAgICAgIHByZWNpc2lvbiAocCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBwcmVjaXNpb246IHAgfSkgfSxcbiAgICAgICAgICAgIGZvcm1hdHRlciAoZikgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBmb3JtYXR0ZXI6IGYgfSkgfSxcblxuICAgICAgICAvKiAgU29tZSB1bmRvY3VtZW50ZWQgaW50ZXJuYWxzICAgICovXG5cbiAgICAgICAgICAgIGxpbWl0OiAocywgbikgPT4gcyAmJiAoKHMubGVuZ3RoIDw9IG4pID8gcyA6IChzLnN1YnN0ciAoMCwgbiAtIDEpICsgJ+KApicpKSxcblxuICAgICAgICAgICAgcmlnaHRBbGlnbjogc3RyaW5ncyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1heCA9IG1heE9mIChzdHJpbmdzLCBzID0+IHMubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdzLm1hcCAocyA9PiAnICcucmVwZWF0IChtYXggLSBzLmxlbmd0aCkgKyBzKSB9LFxuXG4gICAgICAgICAgICBvYmplY3Q6IHggPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKHggaW5zdGFuY2VvZiBTZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgeCA9IEFycmF5LmZyb20gKHgudmFsdWVzICgpKSB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh4IGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIHggPSBBcnJheS5mcm9tICh4LmVudHJpZXMgKCkpIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzQXJyYXkgPSBBcnJheS5pc0FycmF5ICh4KVxuXG4gICAgICAgICAgICAgICAgaWYgKGlzQnJvd3Nlcikge1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHggaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzwnICsgKHgudGFnTmFtZS50b0xvd2VyQ2FzZSAoKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKHguaWQgJiYgKCcjJyArIHguaWQpKSB8fCAnJykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCh4LmNsYXNzTmFtZSAmJiAoJy4nICsgeC5jbGFzc05hbWUpKSB8fCAnJykpICsgJz4nIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHggaW5zdGFuY2VvZiBUZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ0AnICsgc3RyaW5naWZ5LmxpbWl0ICh4Lndob2xlVGV4dCwgMjApIH0gfVxuXG4gICAgICAgICAgICAgICAgaWYgKCFjZmcucHVyZSAmJiAoKGNmZy5kZXB0aCA+IGNmZy5tYXhEZXB0aCkgfHwgKGlzQXJyYXkgJiYgKHgubGVuZ3RoID4gY2ZnLm1heEFycmF5TGVuZ3RoKSkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0FycmF5ID8gJzxhcnJheVsnICsgeC5sZW5ndGggKyAnXT4nIDogJzxvYmplY3Q+JyB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBwcmV0dHkgICA9IGNmZy5wcmV0dHkgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgZW50cmllcyAgPSBPYmplY3QuZW50cmllcyAoeCksXG4gICAgICAgICAgICAgICAgICAgICAgb25lTGluZSAgPSAhcHJldHR5IHx8IChlbnRyaWVzLmxlbmd0aCA8IDIpLFxuICAgICAgICAgICAgICAgICAgICAgIHF1b3RlS2V5ID0gKGNmZy5qc29uID8gKGsgPT4gJ1wiJyArIGVzY2FwZVN0ciAoaykgKyAnXCInKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoayA9PiAvXltBLXpdW0EtejAtOV0qJC8udGVzdCAoaykgPyBrIDogKFwiJ1wiICsgZXNjYXBlU3RyIChrKSArIFwiJ1wiKSkpXG5cbiAgICAgICAgICAgICAgICBpZiAocHJldHR5KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVzICAgICAgICA9IE9iamVjdC52YWx1ZXMgKHgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVkS2V5cyAgID0gc3RyaW5naWZ5LnJpZ2h0QWxpZ24gKE9iamVjdC5rZXlzICh4KS5tYXAgKGsgPT4gcXVvdGVLZXkgKGspICsgJzogJykpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVkVmFsdWVzID0gdmFsdWVzLm1hcCAoc3RyaW5naWZ5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFBhZGRpbmdzICA9IHByaW50ZWRWYWx1ZXMubWFwICgoeCwgaSkgPT4gKCgoeFswXSA9PT0gJ1snKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh4WzBdID09PSAneycpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gM1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKCh0eXBlb2YgdmFsdWVzW2ldID09PSAnc3RyaW5nJykgPyAxIDogMCkpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4TGVmdFBhZGRpbmcgPSBtYXhPZiAobGVmdFBhZGRpbmdzKSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtcyA9IGxlZnRQYWRkaW5ncy5tYXAgKChwYWRkaW5nLCBpKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gJyAnLnJlcGVhdCAobWF4TGVmdFBhZGRpbmcgLSBwYWRkaW5nKSArIHByaW50ZWRWYWx1ZXNbaV1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzQXJyYXkgPyB2YWx1ZSA6IGJ1bGxldCAocHJpbnRlZEtleXNbaV0sIHZhbHVlKSB9KSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVkID0gYnVsbGV0IChpc0FycmF5ID8gJ1sgJyA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneyAnLCBpdGVtcy5qb2luICgnLFxcbicpKSxcblxuICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lcyAgICA9IHByaW50ZWQuc3BsaXQgKCdcXG4nKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdExpbmUgPSBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmludGVkICsgICgnICcucmVwZWF0IChtYXhPZiAobGluZXMsIGwgPT4gbC5sZW5ndGgpIC0gbGFzdExpbmUubGVuZ3RoKSArIChpc0FycmF5ID8gJyBdJyA6ICcgfScpKSB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtcyAgID0gZW50cmllcy5tYXAgKGt2ID0+IChpc0FycmF5ID8gJycgOiAocXVvdGVLZXkgKGt2WzBdKSArICc6ICcpKSArIHN0cmluZ2lmeSAoa3ZbMV0pKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGl0ZW1zLmpvaW4gKCcsICcpXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzQXJyYXlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICgnWycgICsgY29udGVudCArICAnXScpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAoJ3sgJyArIGNvbnRlbnQgKyAnIH0nKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gc3RyaW5naWZ5XG4gICAgfVxuXG5tb2R1bGUuZXhwb3J0cyA9IGNvbmZpZ3VyZSAoe1xuXG4gICAgICAgICAgICAgICAgICAgIGRlcHRoOiAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAgICAgcHVyZTogICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAganNvbjogICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgICAgICAvLyAgY29sb3I6ICAgICAgICAgICBmYWxzZSwgLy8gbm90IHN1cHBvcnRlZCB5ZXRcbiAgICAgICAgICAgICAgICAgICAgbWF4RGVwdGg6ICAgICAgICA1LFxuICAgICAgICAgICAgICAgICAgICBtYXhBcnJheUxlbmd0aDogIDYwLFxuICAgICAgICAgICAgICAgICAgICBtYXhTdHJpbmdMZW5ndGg6IDYwLFxuICAgICAgICAgICAgICAgICAgICBwcmVjaXNpb246ICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgIHByZXR0eTogICAgICAgICAnYXV0bydcblxuICAgICAgICAgICAgICAgIH0pXG5cblxuIl19