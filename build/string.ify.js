"use strict";

function _objectValues(obj) {
    var values = [];
    var keys = Object.keys(obj);

    for (var k = 0; k < keys.length; ++k) values.push(obj[keys[k]]);

    return values;
}

function _objectEntries(obj) {
    var entries = [];
    var keys = Object.keys(obj);

    for (var k = 0; k < keys.length; ++k) entries.push([keys[k], obj[keys[k]]]);

    return entries;
}

const bullet = require('string.bullet'),
      isBrowser = typeof window !== 'undefined' && window.window === window && window.navigator,
      maxOf = (arr, pick) => arr.reduce((max, s) => Math.max(max, pick ? pick(s) : s), 0),
      isInteger = Number.isInteger || (value => typeof value === 'number' && isFinite(value) && Math.floor(value) === value),
      isTypedArray = x => x instanceof Float32Array || x instanceof Float64Array || x instanceof Int8Array || x instanceof Uint8Array || x instanceof Uint8ClampedArray || x instanceof Int16Array || x instanceof Int32Array || x instanceof Uint32Array;

const assignProps = (to, from) => {
    for (const prop in from) {
        Object.defineProperty(to, prop, Object.getOwnPropertyDescriptor(from, prop));
    };return to;
};

const escapeStr = x => x.replace(/\n/g, '\\n').replace(/\'/g, "\\'").replace(/\"/g, '\\"');

const { first, strlen } = require('printable-characters'); // handles ANSI codes and invisible characters

const limit = (s, n) => s && (strlen(s) <= n ? s : first(s, n - 1) + 'â€¦');

const configure = cfg => {

    const stringify = x => {

        const state = Object.assign({ parents: new Set(), siblings: new Map() }, cfg);

        if (cfg.pretty === 'auto') {
            const oneLine = stringify.configure({ pretty: false, siblings: new Map() })(x);
            return oneLine.length <= cfg.maxLength ? oneLine : stringify.configure({ pretty: true, siblings: new Map() })(x);
        }

        var customFormat = cfg.formatter && cfg.formatter(x, stringify);

        if (typeof customFormat === 'string') {
            return customFormat;
        }

        if (typeof jQuery !== 'undefined' && x instanceof jQuery) {
            x = x.toArray();
        } else if (isTypedArray(x)) {
            x = Array.from(x);
        }

        if (isBrowser && x === window) {
            return 'window';
        } else if (!isBrowser && typeof global !== 'undefined' && x === global) {
            return 'global';
        } else if (x === null) {
            return 'null';
        } else if (x instanceof Date) {
            return state.pure ? x.getTime() : "ðŸ“…  " + x.toString();
        } else if (x instanceof RegExp) {
            return state.json ? '"' + x.toString() + '"' : x.toString();
        } else if (state.parents.has(x)) {
            return state.pure ? undefined : '<cyclic>';
        } else if (!state.pure && state.siblings.has(x)) {
            return '<ref:' + state.siblings.get(x) + '>';
        } else if (x && typeof Symbol !== 'undefined' && (customFormat = x[Symbol.for('String.ify')]) && typeof customFormat === 'function' && typeof (customFormat = customFormat.call(x, stringify.configure(state))) === 'string') {

            return customFormat;
        } else if (x instanceof Function) {
            return cfg.pure ? x.toString() : x.name ? '<function:' + x.name + '>' : '<function>';
        } else if (typeof x === 'string') {
            return '"' + escapeStr(limit(x, cfg.pure ? Number.MAX_SAFE_INTEGER : cfg.maxStringLength)) + '"';
        } else if (x instanceof Promise && !state.pure) {
            return '<Promise>';
        } else if (typeof x === 'object') {

            state.parents.add(x);
            state.siblings.set(x, state.siblings.size);

            const result = stringify.configure(Object.assign({}, state, { pretty: state.pretty === false ? false : 'auto', depth: state.depth + 1 })).object(x);

            state.parents.delete(x);

            return result;
        } else if (typeof x === 'number' && !isInteger(x) && cfg.precision > 0) {
            return x.toFixed(cfg.precision);
        } else {
            return String(x);
        }
    };

    /*  API  */

    assignProps(stringify, {

        state: cfg,

        configure: newConfig => configure(Object.assign({}, cfg, newConfig)),

        /*  TODO: generalize generation of these chain-style .configure helpers (maybe in a separate library, as it looks like a common pattern)    */

        get pretty() {
            return stringify.configure({ pretty: true });
        },
        get noPretty() {
            return stringify.configure({ pretty: false });
        },
        get noFancy() {
            return stringify.configure({ fancy: false });
        },
        get noRightAlignKeys() {
            return stringify.configure({ rightAlignKeys: false });
        },

        get json() {
            return stringify.configure({ json: true, pure: true });
        },
        get pure() {
            return stringify.configure({ pure: true });
        },

        maxStringLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxStringLength: n });
        },
        maxArrayLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxArrayLength: n });
        },
        maxObjectLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxObjectLength: n });
        },
        maxDepth(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxDepth: n });
        },
        maxLength(n = Number.MAX_SAFE_INTEGER) {
            return stringify.configure({ maxLength: n });
        },
        indent(n) {
            return stringify.configure({ indent: n });
        },

        precision(p) {
            return stringify.configure({ precision: p });
        },
        formatter(f) {
            return stringify.configure({ formatter: f });
        },

        /*  Some undocumented internals    */

        limit,

        rightAlign: strings => {
            var max = maxOf(strings, s => s.length);
            return strings.map(s => ' '.repeat(max - s.length) + s);
        },

        object: x => {

            if (x instanceof Set) {
                x = Array.from(x.values());
            } else if (x instanceof Map) {
                x = Array.from(x.entries());
            }

            const isArray = Array.isArray(x);

            if (isBrowser) {

                if (x instanceof Element) {
                    return '<' + (x.tagName.toLowerCase() + (x.id && '#' + x.id || '') + (x.className && '.' + x.className || '')) + '>';
                } else if (x instanceof Text) {
                    return '@' + stringify.limit(x.wholeText, 20);
                }
            }

            const entries = _objectEntries(x);

            const tooDeep = cfg.depth > cfg.maxDepth,
                  tooBig = isArray ? entries.length > cfg.maxArrayLength : entries.length > cfg.maxObjectLength;

            if (!cfg.pure && (tooDeep || tooBig)) {
                return '<' + (isArray ? 'array' : 'object') + '[' + entries.length + ']>';
            }

            const quoteKey = cfg.json ? k => '"' + escapeStr(k) + '"' : k => /^[A-z][A-z0-9]*$/.test(k) ? k : "'" + escapeStr(k) + "'";

            if (cfg.pretty) {

                const values = _objectValues(x),
                      right = cfg.rightAlignKeys && cfg.fancy,
                      printedKeys = (right ? stringify.rightAlign : x => x)(Object.keys(x).map(k => quoteKey(k) + ': ')),
                      printedValues = values.map(stringify),
                      brace = isArray ? '[' : '{',
                      endBrace = isArray ? ']' : '}';

                if (cfg.fancy) {

                    const leftPaddings = printedValues.map((x, i) => !right ? 0 : x[0] === '[' || x[0] === '{' ? 3 : typeof values[i] === 'string' ? 1 : 0),
                          maxLeftPadding = maxOf(leftPaddings),
                          items = leftPaddings.map((padding, i) => {
                        const value = ' '.repeat(maxLeftPadding - padding) + printedValues[i];
                        return isArray ? value : bullet(printedKeys[i], value);
                    }),
                          printed = bullet(brace + ' ', items.join(',\n')),
                          lines = printed.split('\n'),
                          lastLine = lines[lines.length - 1];

                    return printed + (' '.repeat(maxOf(lines, l => l.length) - lastLine.length) + ' ' + endBrace);
                } else {

                    const indent = cfg.indent.repeat(cfg.depth);

                    return brace + '\n' + printedValues.map((x, i) => indent + (isArray ? x : printedKeys[i] + x)).join(',\n') + '\n' + cfg.indent.repeat(cfg.depth - 1) + endBrace;
                }
            } else {

                const items = entries.map(kv => (isArray ? '' : quoteKey(kv[0]) + ': ') + stringify(kv[1])),
                      content = items.join(', ');

                return isArray ? '[' + content + ']' : '{ ' + content + ' }';
            }
        }
    });

    return stringify;
};

module.exports = configure({

    depth: 0,
    pure: false,
    json: false,
    //  color:           false, // not supported yet
    maxDepth: 5,
    maxLength: 50,
    maxArrayLength: 60,
    maxObjectLength: 200,
    maxStringLength: 60,
    precision: undefined,
    formatter: undefined,
    pretty: 'auto',
    rightAlignKeys: true,
    fancy: true,
    indent: '    '
});

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUNKO0FBbEhtQixLQUF4Qjs7QUFxSEEsV0FBTyxTQUFQO0FBQ0gsQ0FyTUw7O0FBdU1BLE9BQU8sT0FBUCxHQUFpQixVQUFXOztBQUVSLFdBQWlCLENBRlQ7QUFHUixVQUFpQixLQUhUO0FBSVIsVUFBaUIsS0FKVDtBQUtaO0FBQ0ksY0FBaUIsQ0FOVDtBQU9SLGVBQWlCLEVBUFQ7QUFRUixvQkFBaUIsRUFSVDtBQVNSLHFCQUFpQixHQVRUO0FBVVIscUJBQWlCLEVBVlQ7QUFXUixlQUFpQixTQVhUO0FBWVIsZUFBaUIsU0FaVDtBQWFSLFlBQWdCLE1BYlI7QUFjUixvQkFBaUIsSUFkVDtBQWVSLFdBQWlCLElBZlQ7QUFnQlIsWUFBZ0I7QUFoQlIsQ0FBWCxDQUFqQiIsImZpbGUiOiJzdHJpbmcuaWZ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IGJ1bGxldCAgICAgICA9IHJlcXVpcmUgKCdzdHJpbmcuYnVsbGV0JyksXG4gICAgICBpc0Jyb3dzZXIgICAgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpICYmICh3aW5kb3cud2luZG93ID09PSB3aW5kb3cpICYmIHdpbmRvdy5uYXZpZ2F0b3IsXG4gICAgICBtYXhPZiAgICAgICAgPSAoYXJyLCBwaWNrKSA9PiBhcnIucmVkdWNlICgobWF4LCBzKSA9PiBNYXRoLm1heCAobWF4LCBwaWNrID8gcGljayAocykgOiBzKSwgMCksXG4gICAgICBpc0ludGVnZXIgICAgPSBOdW1iZXIuaXNJbnRlZ2VyIHx8ICh2YWx1ZSA9PiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgJiYgaXNGaW5pdGUgKHZhbHVlKSAmJiAoTWF0aC5mbG9vciAodmFsdWUpID09PSB2YWx1ZSkpLFxuICAgICAgaXNUeXBlZEFycmF5ID0geCA9PiAoeCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBGbG9hdDY0QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50OEFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXkpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICh4IGluc3RhbmNlb2YgSW50MTZBcnJheSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHggaW5zdGFuY2VvZiBJbnQzMkFycmF5KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KVxuXG5jb25zdCBhc3NpZ25Qcm9wcyA9ICh0bywgZnJvbSkgPT4geyBmb3IgKGNvbnN0IHByb3AgaW4gZnJvbSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkgKHRvLCBwcm9wLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIChmcm9tLCBwcm9wKSkgfTsgcmV0dXJuIHRvIH1cblxuY29uc3QgZXNjYXBlU3RyID0geCA9PiB4LnJlcGxhY2UgKC9cXG4vZywgJ1xcXFxuJylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlICgvXFwnL2csIFwiXFxcXCdcIilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlICgvXFxcIi9nLCAnXFxcXFwiJylcblxuY29uc3QgeyBmaXJzdCwgc3RybGVuIH0gPSByZXF1aXJlICgncHJpbnRhYmxlLWNoYXJhY3RlcnMnKSAvLyBoYW5kbGVzIEFOU0kgY29kZXMgYW5kIGludmlzaWJsZSBjaGFyYWN0ZXJzXG5cbmNvbnN0IGxpbWl0ID0gKHMsIG4pID0+IHMgJiYgKChzdHJsZW4gKHMpIDw9IG4pID8gcyA6IChmaXJzdCAocywgbiAtIDEpICsgJ+KApicpKVxuXG5jb25zdCBjb25maWd1cmUgPSBjZmcgPT4ge1xuXG4gICAgY29uc3Qgc3RyaW5naWZ5ID0geCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gT2JqZWN0LmFzc2lnbiAoeyBwYXJlbnRzOiBuZXcgU2V0ICgpLCBzaWJsaW5nczogbmV3IE1hcCAoKSB9LCBjZmcpXG5cbiAgICAgICAgICAgIGlmIChjZmcucHJldHR5ID09PSAnYXV0bycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCAgIG9uZUxpbmUgPSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgcHJldHR5OiBmYWxzZSwgc2libGluZ3M6IG5ldyBNYXAgKCkgfSkgKHgpXG4gICAgICAgICAgICAgICAgcmV0dXJuIChvbmVMaW5lLmxlbmd0aCA8PSBjZmcubWF4TGVuZ3RoKSA/IG9uZUxpbmUgOiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZXR0eTogdHJ1ZSwgIHNpYmxpbmdzOiBuZXcgTWFwICgpIH0pICh4KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgY3VzdG9tRm9ybWF0ID0gY2ZnLmZvcm1hdHRlciAmJiBjZmcuZm9ybWF0dGVyICh4LCBzdHJpbmdpZnkpXG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgY3VzdG9tRm9ybWF0ID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBjdXN0b21Gb3JtYXQgfVxuXG4gICAgICAgICAgICBpZiAoKHR5cGVvZiBqUXVlcnkgIT09ICd1bmRlZmluZWQnKSAmJiAoeCBpbnN0YW5jZW9mIGpRdWVyeSkpIHtcbiAgICAgICAgICAgICAgICB4ID0geC50b0FycmF5ICgpIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoaXNUeXBlZEFycmF5ICh4KSkge1xuICAgICAgICAgICAgICAgIHggPSBBcnJheS5mcm9tICh4KSB9XG5cbiAgICAgICAgICAgIGlmIChpc0Jyb3dzZXIgJiYgKHggPT09IHdpbmRvdykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3dpbmRvdycgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICghaXNCcm93c2VyICYmICh0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgJiYgKHggPT09IGdsb2JhbCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJ2dsb2JhbCcgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICh4ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdudWxsJyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnB1cmUgPyB4LmdldFRpbWUgKCkgOiBcIvCfk4UgIFwiICsgeC50b1N0cmluZyAoKSB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKHggaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUuanNvbiA/ICdcIicgKyB4LnRvU3RyaW5nICgpICsgJ1wiJyA6IHgudG9TdHJpbmcgKCkgfVxuXG4gICAgICAgICAgICBlbHNlIGlmIChzdGF0ZS5wYXJlbnRzLmhhcyAoeCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGUucHVyZSA/IHVuZGVmaW5lZCA6ICc8Y3ljbGljPicgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICghc3RhdGUucHVyZSAmJiBzdGF0ZS5zaWJsaW5ncy5oYXMgKHgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICc8cmVmOicgKyBzdGF0ZS5zaWJsaW5ncy5nZXQgKHgpICsgJz4nIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoeCAmJiAodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgICAgICAgICAgICAgICYmIChjdXN0b21Gb3JtYXQgPSB4W1N5bWJvbC5mb3IgKCdTdHJpbmcuaWZ5JyldKVxuICAgICAgICAgICAgICAgICAgICAgICAmJiAodHlwZW9mIGN1c3RvbUZvcm1hdCA9PT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgICAgICAgICAgICAgICAgJiYgKHR5cGVvZiAoY3VzdG9tRm9ybWF0ID0gY3VzdG9tRm9ybWF0LmNhbGwgKHgsIHN0cmluZ2lmeS5jb25maWd1cmUgKHN0YXRlKSkpID09PSAnc3RyaW5nJykpIHtcblxuICAgICAgICAgICAgICAgIHJldHVybiBjdXN0b21Gb3JtYXQgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICh4IGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGNmZy5wdXJlID8geC50b1N0cmluZyAoKSA6ICh4Lm5hbWUgPyAoJzxmdW5jdGlvbjonICsgeC5uYW1lICsgJz4nKSA6ICc8ZnVuY3Rpb24+JykpIH1cblxuICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHggPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICdcIicgKyBlc2NhcGVTdHIgKGxpbWl0ICh4LCBjZmcucHVyZSA/IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSIDogY2ZnLm1heFN0cmluZ0xlbmd0aCkpICsgJ1wiJyB9XG5cbiAgICAgICAgICAgIGVsc2UgaWYgKCh4IGluc3RhbmNlb2YgUHJvbWlzZSkgJiYgIXN0YXRlLnB1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJzxQcm9taXNlPicgfVxuXG4gICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgeCA9PT0gJ29iamVjdCcpIHtcblxuICAgICAgICAgICAgICAgIHN0YXRlLnBhcmVudHMuYWRkICh4KVxuICAgICAgICAgICAgICAgIHN0YXRlLnNpYmxpbmdzLnNldCAoeCwgc3RhdGUuc2libGluZ3Muc2l6ZSlcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHN0cmluZ2lmeS5jb25maWd1cmUgKE9iamVjdC5hc3NpZ24gKHt9LCBzdGF0ZSwgeyBwcmV0dHk6IHN0YXRlLnByZXR0eSA9PT0gZmFsc2UgPyBmYWxzZSA6ICdhdXRvJywgZGVwdGg6IHN0YXRlLmRlcHRoICsgMSB9KSkub2JqZWN0ICh4KVxuXG4gICAgICAgICAgICAgICAgc3RhdGUucGFyZW50cy5kZWxldGUgKHgpXG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0IH1cblxuICAgICAgICAgICAgZWxzZSBpZiAoKHR5cGVvZiB4ID09PSAnbnVtYmVyJykgJiYgIWlzSW50ZWdlciAoeCkgJiYgKGNmZy5wcmVjaXNpb24gPiAwKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4LnRvRml4ZWQgKGNmZy5wcmVjaXNpb24pIH1cblxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyAoeCkgfVxuICAgICAgICB9XG5cbiAgICAvKiAgQVBJICAqL1xuXG4gICAgICAgIGFzc2lnblByb3BzIChzdHJpbmdpZnksIHtcblxuICAgICAgICAgICAgc3RhdGU6IGNmZyxcblxuICAgICAgICAgICAgY29uZmlndXJlOiBuZXdDb25maWcgPT4gY29uZmlndXJlIChPYmplY3QuYXNzaWduICh7fSwgY2ZnLCBuZXdDb25maWcpKSxcblxuICAgICAgICAvKiAgVE9ETzogZ2VuZXJhbGl6ZSBnZW5lcmF0aW9uIG9mIHRoZXNlIGNoYWluLXN0eWxlIC5jb25maWd1cmUgaGVscGVycyAobWF5YmUgaW4gYSBzZXBhcmF0ZSBsaWJyYXJ5LCBhcyBpdCBsb29rcyBsaWtlIGEgY29tbW9uIHBhdHRlcm4pICAgICovXG5cbiAgICAgICAgICAgIGdldCBwcmV0dHkgICAgICAgICAgICgpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgcHJldHR5OiB0cnVlIH0pIH0sXG4gICAgICAgICAgICBnZXQgbm9QcmV0dHkgICAgICAgICAoKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZXR0eTogZmFsc2UgfSkgfSxcbiAgICAgICAgICAgIGdldCBub0ZhbmN5ICAgICAgICAgICgpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgZmFuY3k6ICBmYWxzZSB9KSB9LFxuICAgICAgICAgICAgZ2V0IG5vUmlnaHRBbGlnbktleXMgKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyByaWdodEFsaWduS2V5czogZmFsc2UgfSkgfSxcblxuICAgICAgICAgICAgZ2V0IGpzb24gKCkgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBqc29uOiB0cnVlLCBwdXJlOiB0cnVlIH0pIH0sXG4gICAgICAgICAgICBnZXQgcHVyZSAoKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHB1cmU6IHRydWUgfSkgfSxcblxuICAgICAgICAgICAgbWF4U3RyaW5nTGVuZ3RoIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4U3RyaW5nTGVuZ3RoOiBuIH0pIH0sXG4gICAgICAgICAgICBtYXhBcnJheUxlbmd0aCAgKG4gPSBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUikgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBtYXhBcnJheUxlbmd0aDogbiB9KSB9LFxuICAgICAgICAgICAgbWF4T2JqZWN0TGVuZ3RoIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4T2JqZWN0TGVuZ3RoOiBuIH0pIH0sXG4gICAgICAgICAgICBtYXhEZXB0aCAgICAgICAgKG4gPSBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUikgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBtYXhEZXB0aDogbiB9KSB9LFxuICAgICAgICAgICAgbWF4TGVuZ3RoICAgICAgIChuID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsgcmV0dXJuIHN0cmluZ2lmeS5jb25maWd1cmUgKHsgbWF4TGVuZ3RoOiBuIH0pIH0sXG4gICAgICAgICAgICBpbmRlbnQgICAgICAgICAgKG4pICAgICAgICAgICAgICAgICAgICAgICAgICAgeyByZXR1cm4gc3RyaW5naWZ5LmNvbmZpZ3VyZSAoeyBpbmRlbnQ6IG4gfSkgfSxcblxuICAgICAgICAgICAgcHJlY2lzaW9uIChwKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IHByZWNpc2lvbjogcCB9KSB9LFxuICAgICAgICAgICAgZm9ybWF0dGVyIChmKSB7IHJldHVybiBzdHJpbmdpZnkuY29uZmlndXJlICh7IGZvcm1hdHRlcjogZiB9KSB9LFxuXG4gICAgICAgIC8qICBTb21lIHVuZG9jdW1lbnRlZCBpbnRlcm5hbHMgICAgKi9cblxuICAgICAgICAgICAgbGltaXQsXG5cbiAgICAgICAgICAgIHJpZ2h0QWxpZ246IHN0cmluZ3MgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXggPSBtYXhPZiAoc3RyaW5ncywgcyA9PiBzLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5ncy5tYXAgKHMgPT4gJyAnLnJlcGVhdCAobWF4IC0gcy5sZW5ndGgpICsgcykgfSxcblxuICAgICAgICAgICAgb2JqZWN0OiB4ID0+IHtcblxuICAgICAgICAgICAgICAgIGlmICh4IGluc3RhbmNlb2YgU2V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHggPSBBcnJheS5mcm9tICh4LnZhbHVlcyAoKSkgfVxuXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoeCBpbnN0YW5jZW9mIE1hcCkge1xuICAgICAgICAgICAgICAgICAgICB4ID0gQXJyYXkuZnJvbSAoeC5lbnRyaWVzICgpKSB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSAoeClcblxuICAgICAgICAgICAgICAgIGlmIChpc0Jyb3dzZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICh4IGluc3RhbmNlb2YgRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8JyArICh4LnRhZ05hbWUudG9Mb3dlckNhc2UgKCkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCh4LmlkICYmICgnIycgKyB4LmlkKSkgfHwgJycpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoeC5jbGFzc05hbWUgJiYgKCcuJyArIHguY2xhc3NOYW1lKSkgfHwgJycpKSArICc+JyB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh4IGluc3RhbmNlb2YgVGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdAJyArIHN0cmluZ2lmeS5saW1pdCAoeC53aG9sZVRleHQsIDIwKSB9IH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IGVudHJpZXMgPSBPYmplY3QuZW50cmllcyAoeClcblxuICAgICAgICAgICAgICAgIGNvbnN0IHRvb0RlZXAgPSAoY2ZnLmRlcHRoID4gY2ZnLm1heERlcHRoKVxuICAgICAgICAgICAgICAgICAgICAsIHRvb0JpZyAgPSAoaXNBcnJheSA/IChlbnRyaWVzLmxlbmd0aCA+IGNmZy5tYXhBcnJheUxlbmd0aCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChlbnRyaWVzLmxlbmd0aCA+IGNmZy5tYXhPYmplY3RMZW5ndGgpKVxuXG4gICAgICAgICAgICAgICAgaWYgKCFjZmcucHVyZSAmJiAodG9vRGVlcCB8fCB0b29CaWcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPCcgKyAoaXNBcnJheSA/ICdhcnJheScgOiAnb2JqZWN0JykgKyAnWycgKyBlbnRyaWVzLmxlbmd0aCArICddPidcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBxdW90ZUtleSA9IChjZmcuanNvbiA/IChrID0+ICdcIicgKyBlc2NhcGVTdHIgKGspICsgJ1wiJykgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGsgPT4gL15bQS16XVtBLXowLTldKiQvLnRlc3QgKGspID8gayA6IChcIidcIiArIGVzY2FwZVN0ciAoaykgKyBcIidcIikpKVxuXG4gICAgICAgICAgICAgICAgaWYgKGNmZy5wcmV0dHkpIHtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZXMgICAgICAgID0gT2JqZWN0LnZhbHVlcyAoeCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0ICAgICAgICAgPSBjZmcucmlnaHRBbGlnbktleXMgJiYgY2ZnLmZhbmN5LFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludGVkS2V5cyAgID0gKHJpZ2h0ID8gc3RyaW5naWZ5LnJpZ2h0QWxpZ24gOiB4ID0+IHgpIChPYmplY3Qua2V5cyAoeCkubWFwIChrID0+IHF1b3RlS2V5IChrKSArICc6ICcpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRlZFZhbHVlcyA9IHZhbHVlcy5tYXAgKHN0cmluZ2lmeSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGJyYWNlICAgICAgICAgPSBpc0FycmF5ID8gJ1snIDogJ3snLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRCcmFjZSAgICAgID0gaXNBcnJheSA/ICddJyA6ICd9J1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZmcuZmFuY3kpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVmdFBhZGRpbmdzID0gcHJpbnRlZFZhbHVlcy5tYXAgKCh4LCBpKSA9PiAoIXJpZ2h0ID8gMCA6ICgoeFswXSA9PT0gJ1snKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoeFswXSA9PT0gJ3snKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKCh0eXBlb2YgdmFsdWVzW2ldID09PSAnc3RyaW5nJykgPyAxIDogMCkpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heExlZnRQYWRkaW5nID0gbWF4T2YgKGxlZnRQYWRkaW5ncyksXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zID0gbGVmdFBhZGRpbmdzLm1hcCAoKHBhZGRpbmcsIGkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gJyAnLnJlcGVhdCAobWF4TGVmdFBhZGRpbmcgLSBwYWRkaW5nKSArIHByaW50ZWRWYWx1ZXNbaV1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0FycmF5ID8gdmFsdWUgOiBidWxsZXQgKHByaW50ZWRLZXlzW2ldLCB2YWx1ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50ZWQgICAgPSBidWxsZXQgKGJyYWNlICsgJyAnLCBpdGVtcy5qb2luICgnLFxcbicpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzICAgICAgPSBwcmludGVkLnNwbGl0ICgnXFxuJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TGluZSAgID0gbGluZXNbbGluZXMubGVuZ3RoIC0gMV1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByaW50ZWQgKyAgKCcgJy5yZXBlYXQgKG1heE9mIChsaW5lcywgbCA9PiBsLmxlbmd0aCkgLSBsYXN0TGluZS5sZW5ndGgpICsgJyAnICsgZW5kQnJhY2UpXG5cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZW50ID0gY2ZnLmluZGVudC5yZXBlYXQgKGNmZy5kZXB0aClcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGJyYWNlICsgJ1xcbicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnRlZFZhbHVlcy5tYXAgKCh4LCBpKSA9PiBpbmRlbnQgKyAoaXNBcnJheSA/IHggOiAocHJpbnRlZEtleXNbaV0gKyB4KSkpLmpvaW4gKCcsXFxuJykgKyAnXFxuJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZmcuaW5kZW50LnJlcGVhdCAoY2ZnLmRlcHRoIC0gMSkgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZEJyYWNlXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbXMgICA9IGVudHJpZXMubWFwIChrdiA9PiAoaXNBcnJheSA/ICcnIDogKHF1b3RlS2V5IChrdlswXSkgKyAnOiAnKSkgKyBzdHJpbmdpZnkgKGt2WzFdKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBpdGVtcy5qb2luICgnLCAnKVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0FycmF5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAoJ1snICArIGNvbnRlbnQgKyAgJ10nKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKCd7ICcgKyBjb250ZW50ICsgJyB9JylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIHN0cmluZ2lmeVxuICAgIH1cblxubW9kdWxlLmV4cG9ydHMgPSBjb25maWd1cmUgKHtcblxuICAgICAgICAgICAgICAgICAgICBkZXB0aDogICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgICAgIHB1cmU6ICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIGpzb246ICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICAgICAgLy8gIGNvbG9yOiAgICAgICAgICAgZmFsc2UsIC8vIG5vdCBzdXBwb3J0ZWQgeWV0XG4gICAgICAgICAgICAgICAgICAgIG1heERlcHRoOiAgICAgICAgNSxcbiAgICAgICAgICAgICAgICAgICAgbWF4TGVuZ3RoOiAgICAgICA1MCxcbiAgICAgICAgICAgICAgICAgICAgbWF4QXJyYXlMZW5ndGg6ICA2MCxcbiAgICAgICAgICAgICAgICAgICAgbWF4T2JqZWN0TGVuZ3RoOiAyMDAsXG4gICAgICAgICAgICAgICAgICAgIG1heFN0cmluZ0xlbmd0aDogNjAsXG4gICAgICAgICAgICAgICAgICAgIHByZWNpc2lvbjogICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6ICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgcHJldHR5OiAgICAgICAgICdhdXRvJyxcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRBbGlnbktleXM6ICB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBmYW5jeTogICAgICAgICAgIHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGluZGVudDogICAgICAgICAnICAgICcsXG4gICAgICAgICAgICAgICAgfSlcblxuXG4iXX0=